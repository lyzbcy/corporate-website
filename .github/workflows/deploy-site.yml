name: Build and Deploy Site

on:
  push:
    branches: [ main ]  # ä»£ç æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ main ]  # PRåˆ°mainåˆ†æ”¯æ—¶ä¹Ÿå¯è§¦å‘ï¼ˆç”¨äºŽæµ‹è¯•æž„å»ºï¼‰

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - uses: actions/checkout@v4  # æ‹‰å–ä»£ç 
      
      # æ­¥éª¤2ï¼šè®¾ç½®å·¥ä½œç›®å½•ï¼ˆå¦‚æžœé¡¹ç›®åœ¨å­ç›®å½•ä¸­ï¼‰
      - name: è®¾ç½®å·¥ä½œç›®å½•
        id: set-workdir
        run: |
          if [ -d "agency-jekyll-theme-master" ]; then
            echo "WORKDIR=${{ github.workspace }}/agency-jekyll-theme-master" >> $GITHUB_ENV
          else
            echo "WORKDIR=${{ github.workspace }}" >> $GITHUB_ENV
          fi
      
      # æ­¥éª¤3ï¼šå®‰è£… Ruby æž„å»ºä¾èµ–ï¼ˆç”¨äºŽç¼–è¯‘ Ruby gem åŽŸç”Ÿæ‰©å±•ï¼‰
      - name: å®‰è£… Ruby æž„å»ºä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libffi-dev zlib1g-dev
      
      # æ­¥éª¤4ï¼šè®¾ç½® Ruby çŽ¯å¢ƒï¼ˆå…ˆè®¾ç½®çŽ¯å¢ƒï¼Œå†å®‰è£…ä¾èµ–ï¼‰
      - name: è®¾ç½® Ruby çŽ¯å¢ƒ
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'  # æ ¹æ®ä½ çš„ Gemfile è¦æ±‚è°ƒæ•´ç‰ˆæœ¬
          bundler-cache: false  # å…ˆç¦ç”¨ç¼“å­˜ï¼Œæ‰‹åŠ¨æŽ§åˆ¶å®‰è£…è¿‡ç¨‹
      
      # æ­¥éª¤5ï¼šæ¸…ç†å¹¶é‡æ–°å®‰è£…ä¾èµ–ï¼ˆç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ç‰ˆæœ¬ï¼‰
      - name: æ¸…ç†å¹¶å®‰è£…ä¾èµ–
        working-directory: ${{ env.WORKDIR }}
        run: |
          # æ¸…ç†å¯èƒ½æŸåçš„ç¼“å­˜
          rm -rf vendor/bundle .bundle
          # æ›´æ–° bundler åˆ°æœ€æ–°ç‰ˆæœ¬
          gem update bundler
          # å¼ºåˆ¶é‡æ–°å®‰è£…æ‰€æœ‰ä¾èµ–
          bundle install --verbose --without development
      
      # æ­¥éª¤6ï¼šæž„å»º Jekyll ç½‘ç«™
      - name: æž„å»ºç½‘ç«™
        working-directory: ${{ env.WORKDIR }}
        run: bundle exec jekyll build
      
      # æ­¥éª¤7ï¼šéƒ¨ç½²åˆ° GitHub Pagesï¼ˆä»…åœ¨ main åˆ†æ”¯æŽ¨é€æ—¶éƒ¨ç½²ï¼‰
      - name: éƒ¨ç½²åˆ°Pages
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'  # ä»…åœ¨ main åˆ†æ”¯æŽ¨é€æ—¶éƒ¨ç½²
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.WORKDIR }}/_site  # Jekyll é»˜è®¤æž„å»ºè¾“å‡ºç›®å½•
          destination_dir: .  # éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯çš„æ ¹ç›®å½•
          # cname: ä½ çš„è‡ªå®šä¹‰åŸŸåï¼ˆå¦‚æžœæœ‰ï¼‰
      
      # æ­¥éª¤8ï¼šè¾“å‡ºéƒ¨ç½²ç½‘å€ï¼ˆä»…åœ¨éƒ¨ç½²æˆåŠŸæ—¶æ˜¾ç¤ºï¼‰
      - name: è¾“å‡ºéƒ¨ç½²ç½‘å€
        if: github.ref == 'refs/heads/main' && github.event_name == 'push' && success()
        run: |
          echo "::notice::ðŸš€ éƒ¨ç½²æˆåŠŸï¼"
          echo "::notice::ðŸ“¦ ä»“åº“ï¼š${{ github.repository }}"
          echo "::notice::ðŸŒ è®¿é—®ç½‘å€ï¼šhttps://lyzbcy.github.io/corporate-website"
          echo ""
          echo "=========================================="
          echo "ðŸŽ‰ GitHub Pages éƒ¨ç½²å®Œæˆï¼"
          echo "ðŸ“¦ ä»“åº“ï¼š${{ github.repository }}"
          echo "ðŸŒ è®¿é—®ç½‘å€ï¼šhttps://lyzbcy.github.io/corporate-website"
          echo "=========================================="
          # è®¾ç½®è¾“å‡ºå˜é‡ï¼Œæ–¹ä¾¿åœ¨å…¶ä»–æ­¥éª¤ä¸­å¼•ç”¨
          echo "deploy_url=https://lyzbcy.github.io/corporate-website" >> $GITHUB_OUTPUT


